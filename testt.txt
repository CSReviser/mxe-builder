void MainWindow::restoreGui()
{
    auto &s = Settings::instance();

    // geometry 復元
    if (!s.mainWindowGeometry.isEmpty()) {
        restoreGeometry(s.mainWindowGeometry);
    }

    // ===== English =====
    for (const auto &p : Constants::EnglishPrograms) {
        if (auto btn = findChild<QToolButton*>(p.objectName)) {
            btn->setChecked(s.enabled[p.keyEnabled]);
            btn->setText(p.titleDefault);   // 固定タイトル
        }
    }

    // ===== Optional =====
    for (const auto &p : Constants::OptionalPrograms) {
        if (auto btn = findChild<QToolButton*>(p.objectName)) {
            btn->setChecked(s.enabled[p.keyEnabled]);

            // INI に保存されたタイトルを復元
            if (!p.keyTitle.isEmpty())
                btn->setText(s.titles[p.keyTitle]);
        }
    }

    // ===== Spec =====
    for (const auto &p : Constants::SpecPrograms) {
        if (auto btn = findChild<QToolButton*>(p.objectName)) {
            btn->setChecked(s.enabled[p.keyEnabled]);

            // INI に保存されたタイトルを復元
            if (!p.keyTitle.isEmpty())
                btn->setText(s.titles[p.keyTitle]);
        }
    }

    // ===== Flag（チェックボックス）=====
    for (const auto &p : Constants::FlagSettings) {
        if (auto cb = findChild<QAbstractButton*>(p.objectName)) {
            cb->setChecked(s.enabled[p.keyEnabled]);
            // ラベルは UI 側の固定値を使うので setText は不要
        }
    }
}

void MainWindow::saveGui()
{
    auto &s = Settings::instance();

    // geometry 保存
    s.saveMainWindow(saveGeometry());

    // enabled の書き戻し
    for (const auto &p : Constants::EnglishPrograms) {
        if (!p.objectName.isEmpty()) {
            if (auto btn = findChild<QToolButton*>(p.objectName)) {
                s.enabled[p.keyEnabled] = btn->isChecked();
            }
        }
    }

    for (const auto &p : Constants::OptionalPrograms) {
        if (!p.objectName.isEmpty()) {
            if (auto btn = findChild<QToolButton*>(p.objectName)) {
                s.enabled[p.keyEnabled] = btn->isChecked();
            }
        }
    }

    for (const auto &p : Constants::SpecPrograms) {
        if (!p.objectName.isEmpty()) {
            if (auto btn = findChild<QToolButton*>(p.objectName)) {
                s.enabled[p.keyEnabled] = btn->isChecked();
            }
        }
    }

    for (const auto &p : Constants::FlagSettings) {
        if (!p.objectName.isEmpty()) {
            if (auto cb = findChild<QAbstractButton*>(p.objectName)) {
                s.enabled[p.keyEnabled] = cb->isChecked();
            }
        }
    }

    // 最後に settings.ini へ保存
    s.save();
}





// Settings.h

#pragma once
#include <QString>
#include <QSettings>
#include <QMap>
#include <QVector>
#include <QByteArray>
#include "constants.h"

class Settings
{
public:
    static Settings& instance();

    void load();
    void save();

    // ===== MainWindow / MessageWindow =====
    void loadMainWindow();
    void saveMainWindow(const QByteArray &geometry);

    void loadMessageWindow();
    void saveMessageWindow(const QByteArray &geometry);

    // ===== 基本設定 =====
    QString audioExtension;
    QString ffmpegFolder;
    QString saveFolder;

    // ===== ProgramEntry の値（enabled / id / title）=====
    // keyEnabled → enabled
    QMap<QString, bool> enabled;

    // keyId → id
    QMap<QString, QString> ids;

    // keyTitle → title
    QMap<QString, QString> titles;

    // ===== optional / spec のプリセット =====
    std::array<QString, Constants::OPT_PRESET_SIZE> optionals;
    std::array<QString, Constants::PRESET_SIZE> specials;

    // ===== geometry =====
    QByteArray mainWindowGeometry;
    QByteArray messageWindowGeometry;

    // ===== CustomizeDialog =====
    QString titleFormat[Constants::ITEM_COUNT];
    QString fileNameFormat[Constants::ITEM_COUNT];

    static QString getTitleFormat(int index);
    static QString getFileNameFormat(int index);

    static void setTitleFormatValue(int index, const QString &value);
    static void setFileNameFormatValue(int index, const QString &value);

    // ===== CheckBox flags =====
    static bool tagSpaceFlag();
    static bool nameSpaceFlag();
    static bool multiGuiFlag();
    static bool kozaSeparationFlag();

    static void setTagSpaceFlag(bool flag);
    static void setNameSpaceFlag(bool flag);
    static void setMultiGuiFlag(bool flag);
    static void setKozaSeparationFlag(bool flag);

private:
    Settings();
    Settings(const Settings&) = delete;
    Settings& operator=(const Settings&) = delete;

    // 内部ヘルパー
    void loadProgramEntry(const Constants::ProgramEntry &p, QSettings &ini);
    void saveProgramEntry(const Constants::ProgramEntry &p, QSettings &ini);
};


//settings.cpp
#include "settings.h"
#include <QSettings>

Settings::Settings()
{
}

Settings& Settings::instance()
{
    static Settings inst;
    return inst;
}

void Settings::load()
{
    QSettings ini(Constants::IniFileName, QSettings::IniFormat);

    // ===== MainWindow =====
    ini.beginGroup(Constants::SETTING_GROUP_MainWindow);

    // English / Optional / Spec / Flag をすべて読み込む
    for (const auto &p : Constants::EnglishPrograms) loadProgramEntry(p, ini);
    for (const auto &p : Constants::OptionalPrograms) loadProgramEntry(p, ini);
    for (const auto &p : Constants::SpecPrograms)     loadProgramEntry(p, ini);
    for (const auto &p : Constants::FlagSettings)     loadProgramEntry(p, ini);

    // audioExtension
    audioExtension = ini.value(Constants::KEY_AudioExtension,
                               Constants::DEFAULT_AudioExtension).toString();

    // saveFolder（null 許容）
    {
        QVariant v = ini.value(Constants::KEY_SaveFolder);
        saveFolder = v.isValid() ? v.toString() : QString();
    }

    // ffmpegFolder（null 許容）
    {
        QVariant v = ini.value(Constants::KEY_FfmpegFolder);
        ffmpegFolder = v.isValid() ? v.toString() : QString();
    }

    mainWindowGeometry = ini.value("geometry").toByteArray();

    ini.endGroup();

    // ===== MessageWindow =====
    ini.beginGroup(Constants::SETTING_GROUP_MessageWindow);
    messageWindowGeometry = ini.value("geometry").toByteArray();
    ini.endGroup();

    // ===== ScrambleDialog =====
    ini.beginGroup(Constants::SETTING_GROUP_ScrambleDialog);
    for (int i = 0; i < Constants::OPT_PRESET_SIZE; ++i)
        optionals[i] = ini.value(QString("optional%1").arg(i + 1), "").toString();
    ini.endGroup();

    // ===== Settingsdialog =====
    ini.beginGroup(Constants::SETTING_GROUP_Settingsdialog);
    for (int i = 0; i < Constants::PRESET_SIZE; ++i)
        specials[i] = ini.value(QString("special%1").arg(i + 1), "").toString();
    ini.endGroup();

    // ===== CustomizeDialog =====
    ini.beginGroup(Constants::SETTING_GROUP_CustomizeDialog);
    for (int i = 0; i < Constants::ITEM_COUNT; ++i) {
        const auto &t = Constants::TITLE_ITEMS[i];
        titleFormat[i] = ini.value(t.key, t.defaultValue).toString();

        const auto &f = Constants::FILENAME_ITEMS[i];
        fileNameFormat[i] = ini.value(f.key, f.defaultValue).toString();
    }
    ini.endGroup();
}

void Settings::save()
{
    QSettings ini(Constants::IniFileName, QSettings::IniFormat);

    ini.beginGroup(Constants::SETTING_GROUP_MainWindow);

    // English / Optional / Spec / Flag をすべて保存
    for (const auto &p : Constants::EnglishPrograms) saveProgramEntry(p, ini);
    for (const auto &p : Constants::OptionalPrograms) saveProgramEntry(p, ini);
    for (const auto &p : Constants::SpecPrograms)     saveProgramEntry(p, ini);
    for (const auto &p : Constants::FlagSettings)     saveProgramEntry(p, ini);

    ini.setValue(Constants::KEY_AudioExtension, audioExtension);

    if (saveFolder.isNull()) ini.remove(Constants::KEY_SaveFolder);
    else ini.setValue(Constants::KEY_SaveFolder, saveFolder);

    if (ffmpegFolder.isNull()) ini.remove(Constants::KEY_FfmpegFolder);
    else ini.setValue(Constants::KEY_FfmpegFolder, ffmpegFolder);

    ini.setValue("geometry", mainWindowGeometry);

    ini.endGroup();

    // ===== MessageWindow =====
    ini.beginGroup(Constants::SETTING_GROUP_MessageWindow);
    ini.setValue("geometry", messageWindowGeometry);
    ini.endGroup();

    // ===== ScrambleDialog =====
    ini.beginGroup(Constants::SETTING_GROUP_ScrambleDialog);
    for (int i = 0; i < Constants::OPT_PRESET_SIZE; ++i)
        ini.setValue(QString("optional%1").arg(i + 1), optionals[i]);
    ini.endGroup();

    // ===== Settingsdialog =====
    ini.beginGroup(Constants::SETTING_GROUP_Settingsdialog);
    for (int i = 0; i < Constants::PRESET_SIZE; ++i)
        ini.setValue(QString("special%1").arg(i + 1), specials[i]);
    ini.endGroup();

    // ===== CustomizeDialog =====
    ini.beginGroup(Constants::SETTING_GROUP_CustomizeDialog);
    for (int i = 0; i < Constants::ITEM_COUNT; ++i) {
        const auto &t = Constants::TITLE_ITEMS[i];
        ini.setValue(t.key, titleFormat[i]);

        const auto &f = Constants::FILENAME_ITEMS[i];
        ini.setValue(f.key, fileNameFormat[i]);
    }
    ini.endGroup();
}

/* ============================================================
 * ProgramEntry 読み込み
 * ============================================================ */
void Settings::loadProgramEntry(const Constants::ProgramEntry &p, QSettings &ini)
{
    // enabled
    enabled[p.keyEnabled] =
        ini.value(p.keyEnabled, p.enabledDefault).toBool();

    // id
    if (!p.keyId.isEmpty())
        ids[p.keyId] = ini.value(p.keyId, p.idDefault).toString();

    // title
    if (!p.keyTitle.isEmpty())
        titles[p.keyTitle] = ini.value(p.keyTitle, p.titleDefault).toString();
}

/* ============================================================
 * ProgramEntry 保存
 * ============================================================ */
void Settings::saveProgramEntry(const Constants::ProgramEntry &p, QSettings &ini)
{
    ini.setValue(p.keyEnabled, enabled[p.keyEnabled]);

    if (!p.keyId.isEmpty())
        ini.setValue(p.keyId, ids[p.keyId]);

    if (!p.keyTitle.isEmpty())
        ini.setValue(p.keyTitle, titles[p.keyTitle]);
}






class Settings {
public:
    static Settings& instance();

    // 既存のマップ
    QMap<QString, bool> englishEnabled;
    QMap<QString, bool> optionalEnabled;
    QMap<QString, bool> specEnabled;
    QMap<QString, bool> checkBoxEnabled;

    // ★ 追加：横断 enabled キャッシュ（INI に保存しない）
    QMap<QString, bool> enabled;

    void buildUnifiedEnabled();   // load() の後に呼ぶ
    void syncEnabledBack();       // save() の前に呼ぶ

    // ...
};


void Settings::buildUnifiedEnabled()
{
    enabled.clear();

    // English
    for (const auto& p : Constants::EnglishPrograms) {
        enabled[p.key] = englishEnabled[p.key];
    }

    // Optional
    for (const auto& p : Constants::OptionalPrograms) {
        enabled[p.keyEnabled] = optionalEnabled[p.keyEnabled];
    }

    // Spec
    for (const auto& p : Constants::SpecPrograms) {
        enabled[p.keyEnabled] = specEnabled[p.keyEnabled];
    }

    // CheckBox
    for (const auto& c : Constants::CheckBoxSettings) {
        enabled[c.keyEnabled] = checkBoxEnabled[c.keyEnabled];
    }
}


void Settings::syncEnabledBack()
{
    // English
    for (const auto& p : Constants::EnglishPrograms) {
        englishEnabled[p.key] = enabled[p.key];
    }

    // Optional
    for (const auto& p : Constants::OptionalPrograms) {
        optionalEnabled[p.keyEnabled] = enabled[p.keyEnabled];
    }

    // Spec
    for (const auto& p : Constants::SpecPrograms) {
        specEnabled[p.keyEnabled] = enabled[p.keyEnabled];
    }

    // CheckBox
    for (const auto& c : Constants::CheckBoxSettings) {
        checkBoxEnabled[c.keyEnabled] = enabled[c.keyEnabled];
    }
}



buildUnifiedEnabled();


syncEnabledBack();


QMap<QString, QString> objectToKey;


MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    using namespace Constants;

    // English
    for (const auto& p : EnglishPrograms) {
        if (!p.objectName.isEmpty())
            objectToKey[p.objectName] = p.key;
    }

    // Optional
    for (const auto& p : OptionalPrograms) {
        if (!p.objectName.isEmpty())
            objectToKey[p.objectName] = p.keyEnabled;
    }

    // Spec
    for (const auto& p : SpecPrograms) {
        if (!p.objectName.isEmpty())
            objectToKey[p.objectName] = p.keyEnabled;
    }

    // CheckBox
    for (const auto& c : CheckBoxSettings) {
        if (!c.objectName.isEmpty())
            objectToKey[c.objectName] = c.keyEnabled;
    }
}


void MainWindow::toggled(bool checked)
{
    auto* button = qobject_cast<QToolButton*>(sender());
    if (!button) return;

    const QString obj = button->objectName();

    // ★ 横断 enabled に書き込むだけ
    if (objectToKey.contains(obj)) {
        const QString key = objectToKey.value(obj);
        settings.enabled[key] = checked;
    }

    // UI のチェックマーク処理
    QString text = button->text();
    const QString check = QString::fromUtf8("✓ ");

    if (text.startsWith(check))
        text.remove(0, check.size());

    if (checked)
        text.prepend(check);

    button->setText(text);
}
