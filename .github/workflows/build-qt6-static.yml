name: Build Qt 6.9 Static and Upload to Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgl1-mesa-dev \
            libxcb-xinerama0-dev \
            libxkbcommon-dev \
            libxcb-cursor-dev \
            libxcb-icccm4-dev \
            libxcb-image0-dev \
            libxcb-keysyms1-dev \
            libxcb-render-util0-dev \
            libxcb-xinput-dev \
            libxcb-xfixes0-dev \
            ninja-build \
            python3 \
            perl \
            cmake \
            curl \
            git \
            wget \
            libfontconfig1-dev \
            libfreetype-dev \
            libgtk-3-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxcb-randr0-dev \
            libxcb-shape0-dev \
            libxcb-shm0-dev \
            libxcb-sync-dev \
            libxrender-dev \
            libharfbuzz-dev \
            libpng-dev \
            meson \
            ninja-build \
            python3-pip

      - name: Create static install dir
        run: sudo mkdir -p /opt/static && sudo chown $USER:$USER /opt/static

      # zlib
      - name: Build zlib (static)
        run: |
          wget https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
          tar xf zlib-1.3.1.tar.gz
          cd zlib-1.3.1
          ./configure --static --prefix=/opt/static
          make -j$(nproc)
          make install

      # libpng
      - name: Build libpng (static)
        run: |
          wget https://download.sourceforge.net/libpng/libpng-1.6.43.tar.gz
          tar xf libpng-1.6.43.tar.gz
          cd libpng-1.6.43
          CPPFLAGS="-I/opt/static/include" LDFLAGS="-L/opt/static/lib" \
          ./configure --disable-shared --enable-static --prefix=/opt/static
          make -j$(nproc)
          make install

      # freetype
      - name: Build freetype (static)
        run: |
          wget https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz
          tar xf freetype-2.13.2.tar.gz
          cd freetype-2.13.2
          ./configure --prefix=/opt/static --enable-static --disable-shared \
            --with-png=yes \
            CPPFLAGS="-I/opt/static/include" \
            LDFLAGS="-L/opt/static/lib"
          make -j$(nproc)
          make install

      # harfbuzz
      - name: Build harfbuzz (static)
        run: |
          wget https://github.com/harfbuzz/harfbuzz/releases/download/8.3.0/harfbuzz-8.3.0.tar.xz
          tar xf harfbuzz-8.3.0.tar.xz
          cd harfbuzz-8.3.0
          mkdir build && cd build
          meson .. \
            --prefix=/opt/static \
            --buildtype=release \
            -Ddefault_library=static \
            -Dfreetype=enabled \
            -Dglib=disabled \
            -Dgobject=disabled \
            -Dicu=disabled \
            -Dtests=disabled \
            -Ddocs=disabled

          ninja
          ninja install
          
      - name: Download Qt 6.9 source
        run: |
          curl -LO https://download.qt.io/official_releases/qt/6.9/6.9.0/single/qt-everywhere-src-6.9.0.tar.xz
          tar xf qt-everywhere-src-6.9.0.tar.xz

      - name: Configure and build Qt statically (make version)
        run: |
          mkdir qt-build
          cd  qt-build
          ../qt-everywhere-src-6.9.0/configure \
            -prefix ../qt-build/qt6-static-install \
            -static -static-runtime \
            -release \
            -opensource -confirm-license \
            -nomake examples -nomake tests \
            -skip qt3d -skip qtwebengine -skip qtwebchannel -skip qtwebview \
            -skip qtcharts -skip qtvirtualkeyboard \
            -skip qtlocation -skip qtsensors -skip qtlottie \
            -skip qtconnectivity -skip qtdoc -skip qttranslations \
            -no-pch \
            -qt-harfbuzz \
            -qt-freetype \
            -qt-libpng \
            -qt-zlib \
            -platform linux-g++ \
            -c++std c++20 

          cmake --build . --parallel
          cmake --install .

#            -platform linux-g++ \
#            -c++std c++20 \
#            -skip qtimageformats -skip qtwebengine \
#            -skip qt3d -skip qt5compat -skip qtactiveqt -skip qtcharts -skip qtcoap -skip qtconnectivity \
#            -skip qtdatavis3d -skip qtdoc -skip qtlottie -skip qtmqtt -skip qtnetworkauth -skip qtopcua \
#            -skip qtserialport -skip qtpositioning -skip qtquicktimeline -skip qtquick3d -skip qtremoteobjects \
#            -skip qtscxml -skip qtsensors -skip qtserialbus -skip qtvirtualkeyboard \
#            -skip qtwebchannel -skip qtwebengine -skip qtwebview -skip qtquick3dphysics -skip qtspeech -skip qtlocation \
#            -skip qthttpserver

      - name: Package Qt
        run: |
          cd qt-build
          tar -czf qt6.9.0-linux-static.tar.gz qt6-static-install

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: qt6.9.0-static-linux
          name: Qt 6.9.0 Static Linux
          files: qt-build/qt6.9.0-linux-static.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
